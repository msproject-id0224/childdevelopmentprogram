import{a as q,r,j as e,H as G,b as c}from"./app-BF_e_Rdy.js";import{A as J}from"./AuthenticatedLayout-DbifM-Jj.js";import{T as v}from"./TextInput-B1g3ssf1.js";import"./Dropdown-DXsKi9BE.js";import"./transition-DGGVtMAX.js";import"./ThemeToggle-5mAKfxz7.js";import"./lang-BBLCHUjz.js";import"./Modal-DWOZPDE9.js";import"./PrimaryButton-kgonJzl3.js";import"./SecondaryButton-Dh5JYrG7.js";import"./DangerButton-Drnabt0D.js";import"./useTheme-H-g0SFOs.js";function oe({auth:A}){const{translations:R}=q().props,n=(t,s={})=>{let i=R?.[t]||t;return Object.keys(s).forEach(m=>{i=i.replace(":"+m,s[m])}),i},d=A.user,[w,D]=r.useState([]),[g,O]=r.useState(""),[a,N]=r.useState(null),[k,x]=r.useState([]),[h,f]=r.useState(""),[_,S]=r.useState(!1),[W,C]=r.useState(!1),[B,Q]=r.useState(null),[T,L]=r.useState(!1),[y,U]=r.useState(""),[l,b]=r.useState(null),M=r.useRef(null),$=r.useRef(null),E=async(t="")=>{try{const s=await c.get(`/api/users/search${t?`?query=${t}`:""}`);D(s.data)}catch(s){console.error("Failed to fetch users",s)}},F=async t=>{if(t)try{const s=await c.get(`/api/chat/${t}`);x(s.data),await c.patch(`/api/chat/${t}/read`)}catch(s){console.error("Failed to fetch messages",s)}};r.useEffect(()=>{if(a&&window.Echo){const t=window.Echo.private(`chat.${d.id}`);return t.listen(".message.typing",s=>{Number(s.senderId)===Number(a.id)&&(L(!0),setTimeout(()=>L(!1),3e3))}),()=>t.stopListening(".message.typing")}},[a]);const z=()=>{W||(C(!0),c.post("/api/chat/typing",{receiver_id:a.id}).catch(()=>{})),clearTimeout(B),Q(setTimeout(()=>C(!1),2e3))};r.useEffect(()=>{E(g);const t=setInterval(()=>{E(g),a&&F(a.id)},3e3);return()=>clearInterval(t)},[g,a]),r.useEffect(()=>{$.current?.scrollIntoView({behavior:"smooth"})},[k,T]);const H=async t=>{if(t.preventDefault(),!h.trim()&&!l||!a||_)return;const s=Date.now(),i={id:s,message:h,sender_id:d.id,receiver_id:a.id,status:"sending",created_at:new Date().toISOString(),attachment_path:l?URL.createObjectURL(l):null,attachment_type:l?l.type:null};x(u=>[...u,i]);const m=h,I=l;f(""),b(null),S(!0);const p=new FormData;p.append("receiver_id",a.id),m&&p.append("message",m),I&&p.append("file",I);try{const u=await c.post("/api/chat",p,{headers:{"Content-Type":"multipart/form-data"}});x(j=>j.map(o=>o.id===s?{...u.data,status:"sent"}:o))}catch{x(j=>j.map(o=>o.id===s?{...o,status:"failed"}:o))}finally{S(!1)}},V=async t=>{if(confirm(n("Are you sure you want to flag this message?")))try{await c.patch(`/api/chat/${t}/flag`),x(s=>s.map(i=>i.id===t?{...i,is_flagged:!0}:i))}catch(s){console.error("Failed to flag message",s)}},P=k.filter(t=>!y||t.message&&t.message.toLowerCase().includes(y.toLowerCase()));return e.jsxs(J,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800 dark:text-gray-200",children:n("Communication")}),children:[e.jsx(G,{title:n("Communication")}),e.jsx("div",{className:"py-6 h-[calc(100vh-120px)]",children:e.jsx("div",{className:"mx-auto max-w-7xl h-full sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex h-full bg-white overflow-hidden shadow-sm sm:rounded-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:`w-full md:w-1/3 border-r border-gray-200 dark:border-gray-700 flex flex-col ${a?"hidden md:flex":"flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsx(v,{type:"text",placeholder:n("Search users..."),className:"w-full",value:g,onChange:t=>O(t.target.value)})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:w.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:n("No users found")}):w.map(t=>e.jsxs("div",{onClick:()=>{N(t),F(t.id)},className:`p-4 flex items-center gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${a?.id===t.id?"bg-blue-50 dark:bg-blue-900/20 border-r-4 border-blue-500":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.avatar_url,alt:t.name,className:"w-10 h-10 rounded-full"}),e.jsx("span",{className:`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white dark:border-gray-800 ${t.is_online?"bg-green-500":"bg-gray-400"}`})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100 truncate",children:t.name}),e.jsx("span",{className:"text-[10px] text-gray-500 uppercase",children:t.role})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:t.last_seen})]})]},t.id))})]}),e.jsx("div",{className:`flex-1 flex flex-col bg-gray-50 dark:bg-gray-900/50 ${a?"fixed inset-0 z-50 md:static md:inset-auto":"hidden md:flex"}`,children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{className:"md:hidden",onClick:()=>N(null),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("img",{src:a.avatar_url,alt:a.name,className:"w-10 h-10 rounded-full"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-bold text-gray-900 dark:text-gray-100",children:a.name}),e.jsx("p",{className:`text-[10px] font-medium uppercase ${a.is_online?"text-green-500":"text-gray-500"}`,children:a.is_online?"Online":"Offline"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{type:"text",placeholder:n("Search in chat..."),className:"text-xs py-1",value:y,onChange:t=>U(t.target.value)})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900",children:[P.map(t=>e.jsxs("div",{className:`flex flex-col ${Number(t.sender_id)===Number(d.id)?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`relative max-w-[85%] sm:max-w-[70%] px-4 py-2 rounded-lg text-sm group ${Number(t.sender_id)===Number(d.id)?"bg-blue-600 text-white rounded-br-none":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 rounded-bl-none"}`,children:[t.attachment_path&&e.jsx("div",{className:"mb-2",children:t.attachment_type?.startsWith("image/")?e.jsx("img",{src:t.attachment_path.startsWith("blob:")?t.attachment_path:`/storage/${t.attachment_path}`,alt:"Attachment",className:"max-w-full rounded-lg"}):e.jsxs("a",{href:`/storage/${t.attachment_path}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 underline text-xs",children:["üìé ",n("Attachment")]})}),t.message,t.is_flagged&&e.jsx("span",{className:"absolute -top-2 -right-2 text-xs bg-red-500 text-white px-1 rounded-full",children:"üö©"}),e.jsx("button",{onClick:()=>V(t.id),className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] text-gray-400 hover:text-red-500",title:n("Flag inappropriate"),children:"üö©"})]}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx("span",{className:"text-[10px] text-gray-500",children:new Date(t.created_at).toLocaleTimeString()}),Number(t.sender_id)===Number(d.id)&&e.jsx("span",{className:"text-[10px]",children:t.is_read?e.jsx("span",{className:"text-blue-500",children:"‚úì‚úì"}):e.jsx("span",{className:"text-gray-400",children:"‚úì"})})]})]},t.id)),T&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 italic",children:e.jsx("span",{className:"animate-pulse",children:n("Typing...")})}),e.jsx("div",{ref:$})]}),e.jsxs("form",{onSubmit:H,className:"p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700",children:[l&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded text-xs",children:[e.jsxs("span",{children:["üìé ",l.name]}),e.jsx("button",{type:"button",onClick:()=>b(null),className:"text-red-500",children:"√ó"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"file",ref:M,className:"hidden",onChange:t=>b(t.target.files[0])}),e.jsx("button",{type:"button",onClick:()=>M.current?.click(),className:"p-2 text-gray-500 hover:text-blue-600 transition-colors",title:n("Attach file"),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})})}),e.jsx(v,{value:h,onChange:t=>{f(t.target.value),z()},className:"flex-1",placeholder:n("Type a message...")}),e.jsx("button",{type:"button",onClick:()=>f(t=>t+"üëç"),className:"p-2 text-gray-500 hover:text-yellow-500 transition-colors",children:"üòä"}),e.jsx("button",{type:"submit",disabled:!h.trim()&&!l||_,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"})})})]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-500",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mb-4 opacity-20",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("p",{children:n("Select a user to start chatting")})]})})]})})})]})}export{oe as default};
